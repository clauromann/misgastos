{% extends "layout.html" %}

{% block content %}
<div class="ingresos-container">
    
    <div class="month-selector-wrapper">
        {% for m in meses %}
        <button onclick="cambiarMes('{{ m }}')" class="month-btn {% if m == mes_actual %}active{% endif %}">
            {{ m }}
        </button>
        {% endfor %}
    </div>

    <h1 class="main-title">INGRESOS {{ mes_actual|upper }}</h1>

    <div class="dashboard-content">
        <div class="chart-card-full">
            <p class="card-label">Evolución Semanal</p>
            <div class="canvas-wrapper">
                <canvas id="chartSemanas"></canvas>
            </div>
        </div>

        <div class="mid-row">
            <div class="chart-card-half">
                <p class="card-label">Reparto por Categoría</p>
                <div class="canvas-wrapper">
                    <canvas id="chartCategorias"></canvas>
                </div>
            </div>
            
            <div class="total-summary-card">
                <span class="total-label">TOTAL MES</span>
                <span class="total-value">{{ "%.0f"|format(total_mes) }}€</span>
            </div>
        </div>
    </div>

    <div class="history-section">
        <h2 class="history-title">Últimos Movimientos</h2>
        <div class="history-list">
            {% for ing in ingresos[:5] %}
            <div class="history-item">
                <div class="h-info">
                    <span class="h-date">{{ ing.fecha.strftime('%d/%m') }}</span>
                    <span class="h-cat">{{ ing.categoria }}</span>
                    <span class="h-concept">{{ ing.concepto or '-' }}</span>
                </div>
                <div class="h-right-side">
                    <span class="h-amount">+{{ "%.2f"|format(ing.cantidad) }}€</span>
                    <button class="btn-delete" onclick="eliminarIngreso('{{ ing.id }}')">
                        &times;
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <button class="fab-add" id="openModal" type="button">+</button>
</div>

{% include 'modals/form_ingreso.html' %}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/ingresos.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/form_ingreso.css') }}">
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const labelsCat = {{ labels_cat|tojson }};
    const valuesCat = {{ values_cat|tojson }};
    const dataSem = {{ datos_semanales|tojson }};
</script>
<script src="{{ url_for('static', filename='js/ingresos.js') }}"></script>
{% endblock %}